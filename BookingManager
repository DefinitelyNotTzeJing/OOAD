import java.util.Scanner;
import java.io.BufferedReader;
import java.io.BufferedWriter;
import java.io.FileWriter;
import java.io.IOException;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.io.File;
import java.io.FileReader;


public class BookingManager 
{
    Scanner scanner = new Scanner(System.in);
    private static int bookingIdCounter = 1;
    private static final SimpleDateFormat DATE_FORMAT = new SimpleDateFormat("yyyy-MM-dd");
    private static final SimpleDateFormat TIME_FORMAT = new SimpleDateFormat("HH:mm");
    
    //create booking method
    public void bookingCreate()
    {
        Scanner bookingCreateInput = new Scanner(System.in);    
        System.out.println("\nEnter booking details");
    
        String name = "";
        boolean validName = false;
        while (!validName)
        {
            System.out.print("Enter your name: ");
            name = bookingCreateInput.nextLine();
            if (!name.matches("[0-9]+"))
            {
                validName = true;
            } else 
            {
                System.out.println("Wrong format. Name cannot contain numerical characters. Please re-enter.");
            }
        }
    
        String date = "";
        boolean validDate = false;
        while (!validDate) 
        {
            System.out.print("Enter date (yyyy-MM-dd): ");
            date = bookingCreateInput.nextLine();
            try 
            {
                DATE_FORMAT.parse(date);
                validDate = true;
            } catch (ParseException e) 
            {
                System.out.println("Wrong format. Please enter date in format yyyy-MM-dd");
            }
        }
    
        String time = "";
        boolean validTime = false;
        while (!validTime) 
        {
            System.out.print("Enter time (HH:mm): ");
            time = bookingCreateInput.nextLine();
            try 
            {
                TIME_FORMAT.parse(time);
                validTime = true;
            } catch (ParseException e) 
            {
                System.out.println("Wrong format. Please enter time in format HH:mm");
            }
        }
    
        File driverFile = new File("driver.txt");
        try
        {
            Scanner driverFileReader = new Scanner(driverFile);
            while (driverFileReader.hasNextLine())
            {
                String driverData = driverFileReader.nextLine();
                String[] driverDataArray = driverData.split(",");
                String driverName = driverDataArray[0];
                String driverTotalRating = driverDataArray[1];
                String driverRatingNum = driverDataArray[2];

                double aDriverTotalRating = Double.parseDouble(driverTotalRating); //convert string to double
                int aDriverRatingNum = Integer.parseInt(driverRatingNum);
                double avgRating = aDriverTotalRating/aDriverRatingNum;

                System.out.println("\nDriver Name: " + driverName);
                System.out.println("Driver average rating: " + avgRating + "(" + aDriverRatingNum + ")");
            }
            driverFileReader.close();

            //input to choose driver
        }catch (IOException e)
        {
            System.out.println("An error occured");
        }
        
        int paymentChoice = 0;
        boolean validPaymentChoice = false;
        while (!validPaymentChoice) 
        {
            System.out.println("\nChoose payment method:");
            System.out.println("1. QR Payment");
            System.out.println("2. Online Banking");
            String paymentInput = bookingCreateInput.nextLine();
            if (paymentInput.equals("1") || paymentInput.equals("2")) 
            {
                paymentChoice = Integer.parseInt(paymentInput);
                validPaymentChoice = true;
            } else 
            {
                System.out.println("Wrong format. Please enter 1 or 2 for payment method.");
            }
        }
        String paymentMethod = (paymentChoice == 1) ? "QR Payment" : "Online Banking";
    
        String departureLocation = "";
        boolean validDepartureLocation = false;
        while (!validDepartureLocation) 
        {
            System.out.print("Enter departure location: ");
            departureLocation = bookingCreateInput.nextLine();
            if (!departureLocation.matches("[0-9]+")) 
            {
                validDepartureLocation = true;
            } else 
            {
                System.out.println("Wrong format. Departure location cannot contain numerical characters. Please re-enter.");
            }
        }
    
        String destination = "";
        boolean validDestination = false;
        while (!validDestination) 
        {
            System.out.print("Enter destination: ");
            destination = bookingCreateInput.nextLine();
            if (!destination.matches("[0-9]+")) 
            {
                validDestination = true;
            } else 
            {
                System.out.println("Wrong format. Destination cannot contain numerical characters. Please re-enter.");
            }
        }
        bookingCreateInput.close();
        
        // Write booking details to file
        try (BufferedWriter writer = new BufferedWriter(new FileWriter("booking.txt", true))) 
        {
            //Increment and format booking ID
            File bookingFile = new File("booking.txt");
            Scanner bookingReader = new Scanner(bookingFile);
            while (bookingReader.hasNextLine())
            {
                bookingIdCounter++;
                bookingReader.nextLine();
            }
            bookingReader.close();
            String bookingId = "B" + String.format("%04d", bookingIdCounter);
            writer.write(bookingId + "|" + name + "|" + date + "|" + time + "|" + paymentMethod + "|" + departureLocation + "|" + destination);
            writer.newLine();
            System.out.println("Booking successful. Your booking ID is: " + bookingId);
        } catch (IOException e) 
        {
            System.out.println("Error writing to file: " + e.getMessage());
        }
    }


    //view booking method
    public void bookingView(String bookingIDInput) 
    {
        try
        {
            String bookingDirectory = "booking.txt";
            File bookingFile = new File(bookingDirectory);
            Scanner bookingReader = new Scanner(bookingFile);
            while (bookingReader.hasNextLine())
            {
                String bookingData = bookingReader.nextLine();
                String dataArray[] = bookingData.contains("|") ? bookingData.split("\\|") : bookingData.split(",");

                if (dataArray[0].equals(bookingIDInput))
                {
                    System.out.println("\n\n\n");
                    System.out.println("Booking ID: " + dataArray[0]);
                    System.out.println("Name: " + dataArray[1]);
                    System.out.println("Date: " + dataArray[2]);
                    System.out.println("Time: " + dataArray[3]);
                    System.out.println("Payment Method: " + dataArray[4]);
                    System.out.println("Departure location: " + dataArray[5]);
                    System.out.println("Destination: " + dataArray[6]);
                }
                //bookingReader.close();
            }

            String bookingViewOption;
            do
            {
                System.out.println("\n\nDo you want to: ");
                System.out.println("<1> Update booking");
                System.out.println("<2> Delete booking");
                System.out.println("<3> Quit");
                System.out.print("---> ");
                Scanner bookingViewInput = new Scanner(System.in);
                bookingViewOption = bookingViewInput.nextLine();
                System.out.println(bookingViewOption);
                bookingViewInput.close();
            }while (!bookingViewOption.equals("1") || !bookingViewOption.equals("2") || !bookingViewOption.equals("3"));

            if (bookingViewOption.equals("1")) // Update booking
            {
                System.out.println("Update Booking");
                //updateBooking(bookingIDInput);
            }
            else if (bookingViewOption.equals("2")) // Delete booking
            {
                System.out.println("Delete Booking");
                //deleteBooking(bookingIDInput);
            }
            else // Quit program
            {
                System.out.print("\033[H\033[2J");
            }
            
        }catch (IOException e)
        {
            System.out.println("An error has occured (booking view)");
        }
    }
}
