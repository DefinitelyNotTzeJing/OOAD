import java.util.Scanner;
import java.time.format.DateTimeFormatter;
import java.io.IOException;
import java.time.LocalDateTime;
import java.io.File;

public class Main 
{
    Scanner inputLoginUI = new Scanner(System.in);
    Scanner inputSystemUI = new Scanner(System.in);

    public int loginUI()
    {
        // Display welcome message and options
        int loginOption = 0;
        do
        {
            System.out.println("\n\nWelcome to the e-Hailing Booking System!");
            System.out.println("1. Register a new account");
            System.out.println("2. Client login");
            System.out.println("3. Administrator login");
            System.out.print("\nChoose an option: ");
            loginOption = inputLoginUI.nextInt();

            if (loginOption != 1 && loginOption != 2 && loginOption != 3)
            {
                System.out.println("Invalid operation (loginUI)");
            }
        }while (loginOption != 1 && loginOption != 2 && loginOption != 3);
        return loginOption;
    }



    private int systemUI()
    {
        Client c = new Client();
        
        int systemOption = 0; //initialize systemOption with a value

        String aGender = c.getGender();
        String username = c.getUsername(); 
        String gender;
        
        if (aGender == "M")
        {
            gender = ("Mr.");
        }
        else
        {
            gender = ("Mrs.");
        }
        
        do 
        {
            DateTimeFormatter dtf = DateTimeFormatter.ofPattern("yyyy/MM/dd HH:mm:ss");
            LocalDateTime now = LocalDateTime.now();  
            System.out.println("\n\nDear " + gender + " " + username + "\t\t\t\t\tCurrent Date and Time " + dtf.format(now)); //get username from login
            System.out.println("Welcome to e-Hailing Booking System");
            System.out.println("_____________________________________________________________________________________________");
            System.out.println("Do you want to: ");
            System.out.println("<1> Create/Request Booking(s)");
            System.out.println("<2> View Booking(s)");
            System.out.println("<3> Quit");
            systemOption = inputSystemUI.nextInt();
            inputSystemUI.nextLine();

            if (systemOption != 1 && systemOption != 2 && systemOption != 3)
            {
                System.out.println("Invalid operation(Line 56)");
            }
        } while (systemOption != 1 && systemOption != 2 && systemOption != 3);

        return systemOption;
    }



    private String bookingUI()
    {
        String bookingID;
        String username;
        String date;
        String time;
        String paymentMethod;

        String bookingIDInput = "0"; //initialize the variable with a temporary value

        Scanner bookingIDInputScanner = new Scanner(System.in);

        System.out.println("Booking ID\tUsername\tDate\tTime\tPayment Method");
        System.out.println("_______________________________________________________________________");
        try
        {
            String bookingDirectory = "booking.txt";
            File loginFile = new File(bookingDirectory);
            Scanner bookingDataReader = new Scanner(loginFile);
            bookingIDInputScanner.close();

            while (bookingDataReader.hasNextLine())
            {
                String bookingData = bookingDataReader.nextLine();
                String[] dataArray = bookingData.split(",");
                bookingDataReader.close();

                bookingID = dataArray[0];
                username = dataArray[1];
                date = dataArray[2];
                time = dataArray[3];
                paymentMethod = dataArray[4];

                System.out.println(bookingID + "\t" + username + "\t" + date + "\t" + time + "\t" + paymentMethod);
            }
            System.out.println("Please enter the respective Booking ID: ");
            bookingIDInput = bookingIDInputScanner.nextLine();
            
        } catch (IOException e)
        {
            System.out.println("An error occured during the booking file opening.");
        }
        return bookingIDInput;
    }



    public String adminSystemUI()
    {
        String bookingID = "0";
        String bookingName;
        String bookingDate;
        String bookingTime;
        String bookingPaymentMethod;

        Scanner adminInput = new Scanner(System.in);
        
        System.out.println("Welcome to e-Hailing Booking System");
        System.out.print("Dear Admin, which booking would you like to choose?\n");
        System.out.print("___________________________________________________________________________________");
        //shows all booking ID with indexes at the front, let the admin choose the booking with its index no
    
        System.out.println("Index No.\tBooking ID\tName\t\t\tDate\t\tTime\tPayment Method");
        int numBooking = 0; // check how many lines are there in the booking text file
        File bookingFile = new File("booking.txt");
        try
        {
            Scanner readerBooking = new Scanner(bookingFile);
            while (readerBooking.hasNextLine())
            {
                numBooking++;
            }
            readerBooking.close();

            for (int i = 1; i < numBooking; i++)
            {
                String data = readerBooking.nextLine();
                String[] dataArrayBooking = data.split(",");
                
                bookingID = dataArrayBooking[0];
                bookingName = dataArrayBooking[1];
                bookingDate = dataArrayBooking[2];
                bookingTime = dataArrayBooking[3];
                bookingPaymentMethod = dataArrayBooking[4];

                System.out.println(i + ".\t\t" + bookingID + "\t" + bookingName + "\t" + bookingDate + "\t" + bookingTime + "\t" + bookingPaymentMethod);
                // readerBooking.close();
            }
            System.out.print("\n\nPlease input the Booking ID to choose the desired booking: ");
            bookingID = adminInput.nextLine();
            adminInput.close();
        } catch(IOException e)
        {
            System.out.println("An error has occured");
            e.getMessage();
        }
        return bookingID;
    }



    public static void main(String[] args) 
    {   
        Main main = new Main();
        // Administrator admin = new Administrator();
        BookingManager book = new BookingManager();
        LoginAndRegister lar = new LoginAndRegister();

        int loginOption, systemOption;
        String adminOption;
        int loginValidateClient; //1 = true, 2 = false
        int loginValidateAdmin;

        String bookingIDInput;

        do
        {
            loginOption = main.loginUI();
            try
            {
                if (loginOption == 1) //client register
                {
                    lar.clientRegister(); 
                }

                else if (loginOption == 2) //client login
                {
                    loginValidateClient = lar.clientLogin();
                    if (loginValidateClient == 1)
                    {
                        systemOption = main.systemUI();
                        if (systemOption == 1) //Create bookings
                        {
                            //create bookings and save the details in respective user text file (make a method in client class and save the booking details in text file)
                            // System.out.println("Create bookings waiting to be done");
                            book.bookingCreate();
                        }

                        else if (systemOption  == 2) //View bookings
                        {
                            //view all bookings and a new interface for the user to update, cancel and search for certain booking 
                            // System.out.println("View bookings waiting to be done");
                            bookingIDInput = main.bookingUI();
                            book.bookingView(bookingIDInput);
                        }

                        else if (systemOption == 3) //Quit program
                        {
                            System.out.println("\033[H\033[2J"); //clear screen
                            System.out.println("Account logout successfully.");
                        }
                    }
                    else
                    {
                        System.out.println("Incorrect username and password. Please try again.");
                    }
                }

                else if (loginOption == 3) //admin login
                {
                    loginValidateAdmin = lar.adminLogin();
                    if (loginValidateAdmin == 1) //admin login succeed
                    {
                        adminOption = main.adminSystemUI();
                        book.bookingView(adminOption); //link to a method to show booking details
                    }
                    else if (loginValidateAdmin == 2) //admin login failed
                    {
                        System.out.println("Incorrect username and password. Please try again.");
                        main.loginUI();
                    }   
                }
                    
            } catch (Exception e)
            {
                System.out.println("\n\nAn error has occured. Please try again\n");
                e.printStackTrace();
            }
        } while (loginOption != 1 && loginOption != 2); 
    }
}
